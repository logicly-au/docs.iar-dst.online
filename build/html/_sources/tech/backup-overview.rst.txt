Backup Overview
================


.. toctree::
   :caption: Table of Contents
   :maxdepth: 4

   backup-overview


Introduction
-------------

We have 2 sites - Global Center and Fitzroy.

We use Dirvish to perform backups.

An offsite copy of production machines is done once a week in Fitzroy, it is sent to Iron Mountain.


Backup Servers
---------------

* Fitzroy: backup01.fz.sdlocal.net

* Global Center: backup02.dc.sdlocal.net

Schedule of Backups
--------------------

Each machine is backed up starting every day at 02:25. Each machine is backed up in turn using rsync.

Kept Backups
------------

* For 14 days we keep daily backups

* We keep 5 weeks of Sunday backups

* We keep the first Sunday of Each Month for 24 months

* So 39 copies should be kept spanning 2 years

File System
------------

Fitzroy - BTRFS
^^^^^^^^^^^^^^^^

* We use BTRFS with compression

* BTRFS dedup is manually run with the command ``/root/bin/bedup dedup``

   * todo: automate this

* An encrypted copy of production machines is taken offsite (luks encrypted ext4)

GC - BTRFS
^^^^^^^^^^^

* We use BTRFS with compression

* TODO: offsite

* TODO: dedup

Virtual Machines
-----------------

We use several types of virtual machines:

* KV Ms - the contents of these unix machines will be backed up using the regular file system backups

* OpenVZ containers - the contents of these unix machines will be backed up using the regular file system backups

* LXC containers - the contents of these unix machines will be backed up using the regular file system backups

* HyperV machines - see windows backup procedures here :doc:`Windows Backup <windows-backup>`

* VMWare machines - new as of August 2018 - being backed up by software called Veamm - IT Strategic are in charge of this

Database Backups
-----------------

We maintain 3 types of databases:

* Postgres Cluster

* Postgres Standalone

* mySQL Cluster and Standalone

Postgres Cluster
^^^^^^^^^^^^^^^^^

The Postgres Cluster uploads its WAL logs to Amazon S3 so that point in time recovery is available.

* Click Here for HA Cluster setup `Tech/Ha Database Setup <https://sdintra.net/bin/view/Tech/HaDatabaseSetup>`_ for a single server failure

* Click Here for HA Cluster Advanced Topics including point in time recovery `Tech/HA Database Advanced Topics <https://sdintra.net/bin/view/Tech/HADatabaseAdvancedTopics>`_ (double failure)

Postgres Standalone
^^^^^^^^^^^^^^^^^^^^

Every night the database is unloaded to text. The regular filesystem backup then backs up these files. The mechanism for this is automatically installed by puppet.

* the only psql standalone server currently is on the powerdns server which

mySQL
^^^^^

Every night the database is unloaded to text. The regular filesystem backup then backs up these files. The mechanism for this is automatically installed by ansible.

GitHub Enterprise
^^^^^^^^^^^^^^^^^^

Every night the data from github is dumped to the backup server using githubs supplied script. This is then pushed down to the datacentre backup server so that there is a replica of the backup which doesn't require us to contact Iron Mountain for retrieval.

Amazon Dynamo DB
-----------------

Point in time backups have been enabled on the Amazon Dynamo DB console for the TMR databases.

Offsite Backup
--------------

Fitzroy
^^^^^^^^

Once a week we send a disc to Iron Mountain.

The disc contains the latest backup of each machine tagged production in Fitzroy by puppet, the disc also contains a backup of the github repos.

An RT ticket exists for each offsite disc.

When a disc is sent to Iron Mountain the location for that disc is updated on its RT Ticket.

For more details see `Tech/Offsite Backup <https://sdintra.net/bin/view/Tech/OffsiteBackup>`_

Other Backup links in tech web
------------------------------

* :doc:`Dirvish Backup <dirvish-backup>` OK (8th Nov 2014)

* `Tech/Enabling Windows <https://sdintra.net/bin/view/Tech/EnablingWindowsBackup>`_ Backup Totally out of date

* :doc:`Windows Backup <windows-backup>` NEW - currently undergoing changes

* `Tech/Offsite Backup <https://sdintra.net/bin/view/Tech/OffsiteBackup>`_ OK (8th Nov 2014)

* `Tech/Backup Documentation <https://sdintra.net/bin/view/Tech/BackupDocumentation>`_

* :doc:`Recovering From Offsite Backup <recovering-offsite-backup>` - Re-written and tested OK (8th Nov 2014)

* :doc:`System Backup And Recovery <system-backup-recovery>` make sure references here are ok, references `Tech.Backup Documentation <https://sdintra.net/bin/view/Tech/BackupDocumentation>`_

* :doc:`Cobian Backup <cobian-backup>` OK (8th Nov 2014)

* `Tech/Data Entry Application <https://sdintra.net/bin/view/Tech/DataEntryApplication>`_ OK (8th Nov 2014)

* `Tech/Windows Home <https://sdintra.net/bin/view/Tech/WindowsHome>`_ OK (8th Nov 2014)

